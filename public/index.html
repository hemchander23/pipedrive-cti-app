<html>

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="viewport" content="width=device-width">

</head>

<body>
    <div class="container-fluid">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Pipedialer</a>
            </div>
        </nav>
        <div class="container">
            <div class="row mt-5">
                <div class="col-sm-4 order-sm-last order-md-first">
                    <label for="speaker-devices" class="form-label">Audio Out</label>
                    <select class="form-select" id="speaker-devices"></select>
                    <br />
                    <label for="ringtone-devices" class="form-label">Audio In</label>
                    <select class="form-select" id="ringtone-devices"></select>
                    <br />
                    <small class="text-muted">If the dropdowns are empty / if you see no devices listed, please click on
                        the `Initiate` button below & grant access to audio devices when the prompt shows up.</small>
                    <br />
                    <br />
                    <button type="button" class="btn btn-primary" id="initiate-dialer">Initiate</button>

                </div>

                <div class="col-sm-4 order-first">
                    <label for="caller-id" class="form-label">ðŸŽ« Your Caller ID</label>
                    <input type="text" readonly class="form-control mb-3" id="caller-id" placeholder="--">

                    <label for="phone-number" class="form-label">ðŸ“ž Phone Number</label>
                    <input type="text" class="form-control mb-3" id="phone-number" placeholder="Enter number">


                    <div class="d-grid gap-2  mb-3">
                        <button type="button" class="btn btn-success" id="make-call">Dial</button>
                    </div>

                </div>
                <div class="col-sm-4 order-last">
                    Logs:
                    <textarea class="form-control" readonly
                        placeholder="Logs appear here. Make sure you click on the 'Initiate' button if you see no audio devices"
                        id="logs" style="height: 400px; font-size:12px;"></textarea>

                </div>


            </div>
        </div>
    </div>


    <script src="src/jquery.min.js"></script>
    <script src="src/twilio.min.js"></script>
    <script src="lib/util.js"></script>
    <script src="lib/audioDevices.js"></script>
    <script src="lib/incomingCallHandler.js"></script>
    <script src="lib/outgoingCallHandler.js"></script>
    <script>
        // SETUP STEP 1: Initiate Dialer
        document.getElementById("initiate-dialer").addEventListener("click", startupClient);

        // SETUP STEP 2: Request an Access Token
        async function startupClient() {
            log("Requesting Access Token...");

            try {
                const data = await $.getJSON("/token");
                log("Got a token.");
                token = data.token;
                log(data.identity);
                $('#caller-id').val(data.identity)
                getAudioDevices();
                intitializeDevice();
            } catch (err) {
                console.log(err);
                log("An error occurred. See your browser console for more information.");
            }
        }

        // SETUP STEP 3:
        // Instantiate a new Twilio.Device
        function intitializeDevice() {
            log("Initializing device");
            device = new Twilio.Device(token, {
                logLevel: 1,
                // Set Opus as our preferred codec. Opus generally performs better, requiring less bandwidth and
                // providing better audio quality in restrained network conditions.
                codecPreferences: ["opus", "pcmu"],
            });

            addDeviceListeners(device);
            // Device must be registered in order to receive incoming calls
            device.register();
        }

        // SETUP STEP 4:
        // Listen for Twilio.Device states
        function addDeviceListeners(device) {
            device.on("registered", function () {
                log("Twilio.Device Ready to make and receive calls!");
                // callControlsDiv.classList.remove("hide");
            });

            device.on("error", function (error) {
                log("Twilio.Device Error: " + error.message);
            });

            device.on("incoming", handleIncomingCall);

            device.audio.on("deviceChange", updateAllAudioDevices.bind(device));

            // Show audio selection UI if it is supported by the browser.
            if (device.audio.isOutputSelectionSupported) {

                // audioSelectionDiv.classList.remove("hide");
            }
        }
    </script>
</body>

</html>